<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Vending Machine</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .animate-slide-out { animation: slideOut 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(8px); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Constants and utilities
        const STARTING_BALANCE = 1000;
        const TICK_MS = 1000; // 1 real second = 1 in-game hour
        
        // GitHub Gist configuration for leaderboard (free database)
        const GIST_ID = "PASTE_YOUR_GIST_ID_HERE"; // Replace with your Gist ID
        const GITHUB_TOKEN = "PASTE_YOUR_TOKEN_HERE"; // Replace with your token
        
        // Dynamic cooldown system based on player progress
        function calculateCooldown(balance, inventory, hourlyIncome) {
            const netWorth = balance + inventory.reduce((sum, item) => {
                if (item.key === 'bitcoin') return sum + (item.qty || 0.01) * 50000; // estimate BTC value
                return sum + (item.boughtAt || item.price || 0);
            }, 0);
            
            // No cooldown for early game (under $10k net worth and <$50/hr income)
            if (netWorth < 10000 && hourlyIncome < 50) return 0;
            
            // Progressive cooldowns based on milestones
            if (netWorth >= 50000000 || hourlyIncome >= 100000) return 24 * 60 * 60 * 1000; // 24 hours
            if (netWorth >= 10000000 || hourlyIncome >= 25000) return 4 * 60 * 60 * 1000;   // 4 hours
            if (netWorth >= 2000000 || hourlyIncome >= 5000) return 60 * 60 * 1000;        // 1 hour
            if (netWorth >= 500000 || hourlyIncome >= 1000) return 30 * 60 * 1000;         // 30 minutes
            if (netWorth >= 100000 || hourlyIncome >= 200) return 15 * 60 * 1000;          // 15 minutes
            if (netWorth >= 25000 || hourlyIncome >= 100) return 5 * 60 * 1000;            // 5 minutes
            
            return 0; // No cooldown for small players
        }

        // Leaderboard functions
        async function fetchLeaderboard() {
            try {
                if (!GIST_ID || GIST_ID === "PASTE_YOUR_GIST_ID_HERE") {
                    // Return mock data if Gist not configured
                    return [
                        { username: "CryptoKing", netWorth: 50000000, hourlyIncome: 125000, lastActive: Date.now() - 3600000, achievements: ["First Millionaire", "Bitcoin Baron"] },
                        { username: "PropertyMogul", netWorth: 25000000, hourlyIncome: 85000, lastActive: Date.now() - 1800000, achievements: ["Real Estate Tycoon"] },
                        { username: "StartupGuru", netWorth: 15000000, hourlyIncome: 45000, lastActive: Date.now() - 7200000, achievements: ["Business Builder"] },
                        { username: "LemonadeStand", netWorth: 2500000, hourlyIncome: 12000, lastActive: Date.now() - 600000, achievements: ["From Zero to Hero"] },
                        { username: "NewPlayer", netWorth: 150000, hourlyIncome: 800, lastActive: Date.now() - 300000, achievements: [] }
                    ].sort((a, b) => b.netWorth - a.netWorth);
                }
                
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`);
                if (!response.ok) throw new Error('Failed to fetch leaderboard');
                
                const gist = await response.json();
                const data = JSON.parse(gist.files['leaderboard.json'].content);
                
                return data.players.sort((a, b) => b.netWorth - a.netWorth).slice(0, 50); // Top 50 players
            } catch (error) {
                console.warn('Failed to fetch leaderboard:', error);
                return [];
            }
        }

        async function submitScore(username, balance, inventory, hourlyIncome) {
            try {
                if (!username || username.length < 3) return false;
                if (!GIST_ID || GIST_ID === "PASTE_YOUR_GIST_ID_HERE") return false;
                if (!GITHUB_TOKEN || GITHUB_TOKEN === "PASTE_YOUR_TOKEN_HERE") return false;
                
                const netWorth = balance + inventory.reduce((sum, item) => {
                    if (item.key === 'bitcoin') return sum + (item.qty || 0.01) * 50000;
                    return sum + (item.boughtAt || item.price || 0);
                }, 0);

                const achievements = [];
                if (netWorth >= 1000000) achievements.push("Millionaire");
                if (netWorth >= 10000000) achievements.push("Multi-Millionaire"); 
                if (hourlyIncome >= 10000) achievements.push("Income Giant");
                if (inventory.some(i => i.key === 'bitcoin')) achievements.push("Crypto Investor");
                if (inventory.filter(i => i.category === 'passive_property').length >= 10) achievements.push("Real Estate Tycoon");

                // Fetch current leaderboard
                const currentData = await fetchLeaderboard();
                
                // Update or add player
                const playerIndex = currentData.findIndex(p => p.username === username);
                const playerData = {
                    username,
                    netWorth: Math.round(netWorth),
                    hourlyIncome: Math.round(hourlyIncome),
                    lastActive: Date.now(),
                    achievements
                };
                
                if (playerIndex >= 0) {
                    currentData[playerIndex] = playerData;
                } else {
                    currentData.push(playerData);
                }
                
                // Keep only top 100 players
                const sortedData = currentData.sort((a, b) => b.netWorth - a.netWorth).slice(0, 100);
                
                // Update Gist
                const updateData = {
                    files: {
                        'leaderboard.json': {
                            content: JSON.stringify({
                                players: sortedData,
                                lastUpdated: Date.now()
                            }, null, 2)
                        }
                    }
                };
                
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                return response.ok;
            } catch (error) {
                console.warn('Failed to submit score:', error);
                return false;
            }
        }

        // Expanded item database with much more variety
        const BASE_ITEMS = [
            // Starting tier ($500-$5k)
            { key: "lemonade_stand", name: "Lemonade Stand", category: "low_passive", price: 500, hourly: 2 },
            { key: "lawn_mower", name: "Lawn Mowing Service", category: "low_passive", price: 800, hourly: 3 },
            { key: "food_truck", name: "Food Truck", category: "business", price: 15000, hourly: 25 },
            { key: "etsy_shop", name: "Etsy Craft Shop", category: "business", price: 2000, hourly: 8 },
            
            // Small business tier ($10k-$100k)
            { key: "coffee_shop", name: "Coffee Shop", category: "business", price: 120000, hourly: 1400 },
            { key: "laundromat", name: "Laundromat", category: "business", price: 75000, hourly: 900 },
            { key: "car_wash", name: "Car Wash", category: "business", price: 85000, hourly: 1100 },
            { key: "ice_cream_truck", name: "Ice Cream Truck", category: "business", price: 45000, hourly: 600 },
            { key: "pet_grooming", name: "Pet Grooming Salon", category: "business", price: 55000, hourly: 750 },
            
            // Real estate tier ($50k-$500k)
            { key: "rental_house", name: "Rental House", category: "passive_property", price: 50000, hourly: 500 },
            { key: "duplex", name: "Duplex Property", category: "passive_property", price: 120000, hourly: 1200 },
            { key: "apartment_building", name: "Small Apartment Building", category: "passive_property", price: 300000, hourly: 2800 },
            { key: "office_space", name: "Commercial Office Space", category: "passive_property", price: 250000, hourly: 2200 },
            { key: "warehouse", name: "Storage Warehouse", category: "passive_property", price: 180000, hourly: 1600 },
            
            // Luxury/Depreciation tier ($100k-$1M)
            { key: "sports_car", name: "Sports Car", category: "luxury", price: 250000, hourly: 0, depreciation: true },
            { key: "yacht", name: "Luxury Yacht", category: "luxury", price: 800000, hourly: 0, depreciation: true },
            { key: "private_jet", name: "Private Jet", category: "luxury", price: 2000000, hourly: 0, depreciation: true },
            { key: "mansion", name: "Beverly Hills Mansion", category: "luxury", price: 5000000, hourly: 0, depreciation: true },
            { key: "art_collection", name: "Fine Art Collection", category: "luxury", price: 1200000, hourly: 0, depreciation: false },
            
            // High-tier businesses ($500k-$10M)
            { key: "restaurant_chain", name: "Restaurant Chain (5 locations)", category: "business", price: 1500000, hourly: 12000 },
            { key: "hotel", name: "Boutique Hotel", category: "business", price: 3200000, hourly: 25000 },
            { key: "gas_station", name: "Gas Station Franchise", category: "business", price: 800000, hourly: 7500 },
            { key: "gym_chain", name: "Fitness Center Chain", category: "business", price: 1100000, hourly: 9500 },
            { key: "auto_dealership", name: "Car Dealership", category: "business", price: 2800000, hourly: 22000 },
            
            // Mega properties ($1M-$50M)
            { key: "shopping_mall", name: "Shopping Mall", category: "high_passive", price: 5000000, hourly: 30000 },
            { key: "skyscraper", name: "Downtown Skyscraper", category: "high_passive", price: 15000000, hourly: 85000 },
            { key: "casino", name: "Las Vegas Casino", category: "high_passive", price: 25000000, hourly: 150000 },
            { key: "airport", name: "Regional Airport", category: "high_passive", price: 45000000, hourly: 280000 },
            { key: "oil_rig", name: "Offshore Oil Rig", category: "high_passive", price: 35000000, hourly: 220000 },
            
            // Tech/Modern tier ($100k-$5M)
            { key: "app_startup", name: "Mobile App Startup", category: "tech", price: 500000, hourly: 4000 },
            { key: "youtube_channel", name: "YouTube Channel", category: "tech", price: 50000, hourly: 800 },
            { key: "saas_company", name: "SaaS Software Company", category: "tech", price: 2000000, hourly: 18000 },
            { key: "crypto_mining", name: "Bitcoin Mining Farm", category: "tech", price: 1200000, hourly: 8500 },
            { key: "nft_collection", name: "NFT Art Collection", category: "tech", price: 300000, hourly: 0, depreciation: true },
            
            // Unique/Fun items ($1k-$100k)
            { key: "food_cart", name: "Hot Dog Cart", category: "novelty", price: 8000, hourly: 15 },
            { key: "vending_machine", name: "Snack Vending Machine", category: "low_passive", price: 5000, hourly: 12 },
            { key: "atm_machine", name: "ATM Machine", category: "low_passive", price: 25000, hourly: 180 },
            { key: "solar_panels", name: "Solar Panel Array", category: "passive_property", price: 80000, hourly: 600 },
            { key: "wind_turbine", name: "Wind Turbine", category: "passive_property", price: 150000, hourly: 1100 },
        ];

        // Enhanced market events with more variety
        const MARKET_EVENTS = [
            { id: "housing_boom", label: "Housing Market Boom", effect: (state) => ({ propertyMultiplier: 1.3 }), durationTicks: 48 },
            { id: "housing_crash", label: "Housing Market Crash", effect: (state) => ({ propertyMultiplier: 0.7 }), durationTicks: 36 },
            { id: "btc_moon", label: "Bitcoin Bull Run", effect: (state) => ({ btcMultiplier: 1.8 }), durationTicks: 24 },
            { id: "btc_crash", label: "Crypto Winter", effect: (state) => ({ btcMultiplier: 0.4 }), durationTicks: 72 },
            { id: "business_grant", label: "Small Business Stimulus", effect: (state) => ({ businessIncome: 1.25 }), durationTicks: 48 },
            { id: "recession", label: "Economic Recession", effect: (state) => ({ businessIncome: 0.8, propertyMultiplier: 0.85 }), durationTicks: 96 },
            { id: "tax_hike", label: "Capital Gains Tax Increase", effect: (state) => ({ sellFee: 1.2 }), durationTicks: 72 },
            { id: "tech_bubble", label: "Tech Stock Bubble", effect: (state) => ({ techMultiplier: 1.5 }), durationTicks: 36 },
            { id: "oil_spike", label: "Energy Crisis", effect: (state) => ({ businessIncome: 0.9, oilMultiplier: 2.0 }), durationTicks: 48 },
            { id: "tourism_boom", label: "Tourism Surge", effect: (state) => ({ hotelMultiplier: 1.4 }), durationTicks: 60 },
            { id: "supply_chain", label: "Supply Chain Issues", effect: (state) => ({ businessIncome: 0.85 }), durationTicks: 48 },
            { id: "luxury_tax", label: "Luxury Goods Tax", effect: (state) => ({ luxuryPenalty: 1.3 }), durationTicks: 72 },
        ];

        function inferItemFromText(text) {
            if (!text) return null;
            const s = text.toLowerCase();
            if (s.includes("bitcoin") || s.includes("btc")) return { inferred: true, key: "bitcoin", name: "Bitcoin", category: "crypto" };
            if (s.includes("rental") || s.includes("house") || s.includes("apartment")) return { inferred: true, key: "rental_house", ...BASE_ITEMS.find(i=>i.key==='rental_house') };
            if (s.includes("lemonade")) return { inferred: true, key: "lemonade_stand", ...BASE_ITEMS.find(i=>i.key==='lemonade_stand') };
            if (s.includes("coffee")) return { inferred: true, key: "coffee_shop", ...BASE_ITEMS.find(i=>i.key==='coffee_shop') };
            if (s.includes("car") || s.includes("ferrari") || s.includes("lamborghini")) return { inferred: true, key: "sports_car", ...BASE_ITEMS.find(i=>i.key==='sports_car') };
            if (s.includes("mall") || s.includes("shopping")) return { inferred: true, key: "shopping_mall", ...BASE_ITEMS.find(i=>i.key==='shopping_mall') };
            if (s.includes("shop") || s.includes("business")) return { inferred: true, key: "coffee_shop", ...BASE_ITEMS.find(i=>i.key==='coffee_shop') };
            const m = s.match(/\$?([0-9,]+)k?/);
            if (m) return null;
            return { inferred: true, key: `novel_${Math.random().toString(36).slice(2,8)}`, name: text, category: 'novelty' };
        }

        function formatMoney(n) {
            return `$${n.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        }

        // Sound utility
        function useSfx() {
            const ctxRef = useRef(null);
            useEffect(()=>{
                try{
                    ctxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }catch(e){ctxRef.current=null}
            },[]);
            const beep = (freq=880, time=0.05) => {
                const ctx = ctxRef.current; if(!ctx) return;
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.type = 'sine'; o.frequency.value = freq; g.gain.value = 0.05;
                o.connect(g); g.connect(ctx.destination);
                o.start(); o.stop(ctx.currentTime + time);
            };
            const kaChing = ()=>{beep(1320,0.08); beep(1760,0.06)};
            const error = ()=>{beep(220,0.12)};
            return { kaChing, error };
        }

        // Leaderboard Modal Component
        function LeaderboardModal({ isOpen, onClose, leaderboard, currentUser }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={onClose}>
                    <div className="bg-slate-900 rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-2xl font-bold text-white">🏆 Global Leaderboard</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        
                        <div className="space-y-3">
                            {leaderboard.map((player, idx) => {
                                const isCurrentUser = player.username === currentUser;
                                const isTop3 = idx < 3;
                                const rank = idx + 1;
                                const trophy = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `#${rank}`;
                                
                                return (
                                    <div key={player.username} className={`p-4 rounded-lg ${isCurrentUser ? 'bg-emerald-600/20 border border-emerald-500/30' : 'bg-white/5'} ${isTop3 ? 'border border-yellow-500/30' : ''}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="text-xl font-bold w-12">{trophy}</div>
                                                <div>
                                                    <div className="font-semibold text-white">{player.username} {isCurrentUser ? '(You)' : ''}</div>
                                                    <div className="text-sm text-slate-300">
                                                        Net Worth: {formatMoney(player.netWorth)} • Income: {formatMoney(player.hourlyIncome)}/hr
                                                    </div>
                                                    <div className="text-xs text-slate-400">
                                                        Last seen: {new Date(player.lastActive).toLocaleTimeString()}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="flex flex-wrap gap-1 justify-end">
                                                    {player.achievements.map(achievement => (
                                                        <span key={achievement} className="px-2 py-1 bg-blue-600/20 text-blue-300 text-xs rounded">
                                                            {achievement}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div className="mt-6 text-center text-slate-400 text-sm">
                            Scores auto-update every 5 minutes for players with $25k+ net worth
                        </div>
                    </div>
                </div>
            );
        }
        function AnimatedMessage({ message, index }) {
            const [visible, setVisible] = useState(true);
            
            useEffect(() => {
                const timer = setTimeout(() => setVisible(false), 5000);
                return () => clearTimeout(timer);
            }, []);

            if (!visible) return null;

            const bgClass = message.type === 'err' ? 'bg-red-600/30' : 
                           message.type === 'event' ? 'bg-amber-500/20' : 'bg-emerald-600/10';
            
            return (
                <div className={`p-2 rounded animate-fade-in ${bgClass}`}>
                    <div className="text-sm">{message.text}</div>
                </div>
            );
        }

        // Main App component
        function App() {
            const [username, setUsername] = useState(() => localStorage.getItem('mvm_user') || '');
            const [balance, setBalance] = useState(() => Number(localStorage.getItem('mvm_balance') || STARTING_BALANCE));
            const [inventory, setInventory] = useState(() => JSON.parse(localStorage.getItem('mvm_inventory') || '[]'));
            const [btcPrice, setBtcPrice] = useState(() => Number(localStorage.getItem('mvm_btc') || 30000));
            const [lastUse, setLastUse] = useState(() => Number(localStorage.getItem('mvm_lastuse') || 0));
            const [requestText, setRequestText] = useState('');
            const [messages, setMessages] = useState([]);
            const [events, setEvents] = useState([]);
            const [tick, setTick] = useState(0);
            const [hourlyIncome, setHourlyIncome] = useState(0);
            const [marketState, setMarketState] = useState({ propertyMultiplier:1, btcMultiplier:1, businessIncome:1, sellFee:1 });
            const [leaderboard, setLeaderboard] = useState([]);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [lastScoreSubmit, setLastScoreSubmit] = useState(() => Number(localStorage.getItem('mvm_lastscore') || 0));
            const sfx = useSfx();

            // Autosave to localStorage
            useEffect(()=>{ localStorage.setItem('mvm_user', username); },[username]);
            useEffect(()=>{ localStorage.setItem('mvm_balance', balance); },[balance]);
            useEffect(()=>{ localStorage.setItem('mvm_inventory', JSON.stringify(inventory)); },[inventory]);
            useEffect(()=>{ localStorage.setItem('mvm_lastuse', lastUse); },[lastUse]);
            useEffect(()=>{ localStorage.setItem('mvm_btc', btcPrice); },[btcPrice]);
            // Load leaderboard on mount
            useEffect(() => {
                fetchLeaderboard().then(setLeaderboard);
            }, []);

            // Auto-submit score every 5 minutes if significant progress
            useEffect(() => {
                const interval = setInterval(async () => {
                    if (username && Date.now() - lastScoreSubmit > 5 * 60 * 1000) {
                        const netWorth = balance + inventory.reduce((sum, item) => {
                            if (item.key === 'bitcoin') return sum + (item.qty || 0.01) * 50000;
                            return sum + (item.boughtAt || item.price || 0);
                        }, 0);
                        
                        // Only submit if net worth > $25k to avoid spam
                        if (netWorth > 25000) {
                            await submitScore(username, balance, inventory, hourlyIncome);
                            setLastScoreSubmit(Date.now());
                            // Refresh leaderboard
                            fetchLeaderboard().then(setLeaderboard);
                        }
                    }
                }, 60000); // Check every minute
                
                return () => clearInterval(interval);
            }, [username, balance, inventory, hourlyIncome, lastScoreSubmit]);

            // Passive income tick
            useEffect(()=>{
                const id = setInterval(()=>{
                    setTick(t=>t+1);
                    let inc = 0;
                    inventory.forEach(item=>{
                        if(item.hourly) {
                            let h = item.hourly;
                            if(item.category && item.category.includes('passive')) h = h * marketState.propertyMultiplier;
                            if(item.category === 'business') h = h * marketState.businessIncome;
                            const countSame = inventory.filter(i=>i.key===item.key).length;
                            if(countSame>10) h *= Math.pow(0.9, countSame-10);
                            inc += h;
                        }
                    });
                    setHourlyIncome(inc); // Track current income
                    if(inc>0) setBalance(b => Math.round((b + inc) * 100) / 100);

                    setEvents(ev=>{
                        if(ev.length===0) return ev;
                        const next = ev.map(e=>({...e, remaining: e.remaining - 1})).filter(e=>e.remaining>0);
                        let ms = { propertyMultiplier:1, btcMultiplier:1, businessIncome:1, sellFee:1 };
                        next.forEach(e=>{ ms = {...ms, ...e.effect()} });
                        setMarketState(ms);
                        return next;
                    });
                }, TICK_MS);
                return ()=>clearInterval(id);
            },[inventory, marketState]);

            // BTC price fetcher
            useEffect(()=>{
                let mounted = true;
                async function fetchBtc(){
                    try{
                        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                        const j = await res.json();
                        if(!mounted) return;
                        const price = j.bitcoin.usd;
                        setBtcPrice(p=> Math.round(((p*0.9) + (price*0.1 * marketState.btcMultiplier)) ));
                    }catch(e){ console.warn('btc fetch failed', e); }
                }
                fetchBtc();
                const id = setInterval(fetchBtc, 15000);
                return ()=>{ mounted=false; clearInterval(id); };
            },[marketState.btcMultiplier]);

            // Random market events
            useEffect(()=>{
                const id = setInterval(()=>{
                    if(Math.random() < 0.06) {
                        const ev = MARKET_EVENTS[Math.floor(Math.random()*MARKET_EVENTS.length)];
                        setEvents(es=>[...es, { ...ev, remaining: ev.durationTicks, effect: () => ev.effect() }]);
                        setMessages(m=>[{type:'event', text: `Market Event: ${ev.label} started!`} , ...m].slice(0,20));
                        sfx.kaChing();
                    }
                }, 60000);
                return ()=>clearInterval(id);
            },[]);

            const handleUseMachine = async () => {
                const now = Date.now();
                const currentCooldown = calculateCooldown(balance, inventory, hourlyIncome);
                
                if(now - lastUse < currentCooldown) { 
                    sfx.error(); 
                    const remainingMs = currentCooldown - (now - lastUse);
                    const timeText = remainingMs >= 60*60*1000 ? 
                        `${(remainingMs/(60*60*1000)).toFixed(1)}h` : 
                        `${(remainingMs/60000).toFixed(1)}m`;
                    setMessages(m=>[{type:'err', text:`Machine cooling down for ${timeText} more.`}, ...m].slice(0,20)); 
                    return; 
                }
                if(!username) { 
                    sfx.error(); 
                    setMessages(m=>[{type:'err', text:'Please enter a username first.'}, ...m].slice(0,20)); 
                    return; 
                }
                
                const infer = inferItemFromText(requestText || 'mystery item');
                let item = null;
                
                if(infer && infer.key==='bitcoin'){
                    const quantity = 0.01; 
                    const cost = Math.round(btcPrice * quantity);
                    if(balance < cost){ 
                        sfx.error(); 
                        setMessages(m=>[{type:'err', text:`Not enough cash to buy ${quantity} BTC (${formatMoney(cost)})`}, ...m].slice(0,20)); 
                        return; 
                    }
                    setBalance(b=>b-cost); 
                    setInventory(inv=>[{ key:'bitcoin', name:`Bitcoin (0.01)`, category:'crypto', qty:quantity, pricePerUnit: btcPrice }, ...inv]);
                    setLastUse(now); 
                    setMessages(m=>[{type:'ok', text:`Purchased ${quantity} BTC for ${formatMoney(cost)}`}, ...m].slice(0,20)); 
                    sfx.kaChing();
                    return;
                }
                
                if(infer && infer.key){
                    const db = BASE_ITEMS.find(x=>x.key===infer.key);
                    if(db){
                        const price = Math.round(db.price * (db.category.includes('passive') ? marketState.propertyMultiplier : 1));
                        if(balance < price){ 
                            sfx.error(); 
                            setMessages(m=>[{type:'err', text:`Not enough cash to buy ${db.name} (${formatMoney(price)})`}, ...m].slice(0,20)); 
                            return; 
                        }
                        setBalance(b=>b-price);
                        setInventory(inv=>[{...db, boughtAt: price, id: Math.random().toString(36).slice(2,9)}, ...inv]);
                        setLastUse(now); 
                        setMessages(m=>[{type:'ok', text:`Purchased ${db.name} for ${formatMoney(price)}`}, ...m].slice(0,20)); 
                        sfx.kaChing();
                        return;
                    }
                }
                
                const noveltyPrice = Math.max(50, Math.round(Math.random()*5000));
                if(balance < noveltyPrice){ 
                    sfx.error(); 
                    setMessages(m=>[{type:'err', text:`Not enough cash (${formatMoney(noveltyPrice)})`}, ...m].slice(0,20)); 
                    return; 
                }
                setBalance(b=>b-noveltyPrice);
                setInventory(inv=>[{ key: infer.key || 'novel', name: infer.name || requestText, category:'novelty', price: noveltyPrice, hourly: 0, id: Math.random().toString(36).slice(2,9) }, ...inv]);
                setLastUse(now); 
                setMessages(m=>[{type:'ok', text:`The machine gave you: ${infer.name || requestText} for ${formatMoney(noveltyPrice)}`}, ...m].slice(0,20)); 
                sfx.kaChing();
            };

            const canUseMachine = () => {
                const currentCooldown = calculateCooldown(balance, inventory, hourlyIncome);
                return Date.now() - lastUse >= currentCooldown;
            };
            
            const getCooldownInfo = () => {
                const currentCooldown = calculateCooldown(balance, inventory, hourlyIncome);
                if (currentCooldown === 0) return { canUse: true, text: 'Ready' };
                
                const remaining = Math.max(0, currentCooldown - (Date.now() - lastUse));
                if (remaining === 0) return { canUse: true, text: 'Ready' };
                
                const timeText = remaining >= 60*60*1000 ? 
                    `${(remaining/(60*60*1000)).toFixed(1)}h` : 
                    `${(remaining/60000).toFixed(1)}m`;
                return { canUse: false, text: `Cooldown ${timeText}` };
            };

            const calculateNetWorth = () => {
                return balance + inventory.reduce((sum, item) => {
                    if (item.key === 'bitcoin') return sum + (item.qty || 0.01) * btcPrice;
                    return sum + (item.boughtAt || item.price || 0);
                }, 0);
            };

            const sellItem = (idx) => {
                const it = inventory[idx];
                if(!it) return;
                let sellPrice = 0;
                if(it.key === 'bitcoin'){
                    sellPrice = Math.round((it.qty || 0.01) * btcPrice * marketState.btcMultiplier);
                }else if(it.boughtAt){
                    const base = it.boughtAt;
                    const mult = it.category==='luxury' ? 0.7 : (Math.random()*0.5 + 0.85);
                    sellPrice = Math.round(base * mult / marketState.sellFee);
                }else if(it.price){ 
                    sellPrice = Math.round(it.price * (Math.random()*0.6 + 0.7)); 
                }
                setBalance(b=>b+sellPrice);
                setInventory(inv=>inv.filter((_,i)=>i!==idx));
                setMessages(m=>[{type:'ok', text:`Sold ${it.name} for ${formatMoney(sellPrice)}`}, ...m].slice(0,20));
                sfx.kaChing();
            };

            const resetGame = ()=>{
                if(!confirm('Reset game? This clears local progress.')) return;
                localStorage.clear(); 
                window.location.reload();
            };

            // Filter popular items for Quick Shop based on player's budget
            const getPopularItems = () => {
                const budget = balance;
                let items = [];
                
                // Always show a few starter items
                items.push(...BASE_ITEMS.filter(item => item.price <= 5000).slice(0, 3));
                
                // Add items within budget range
                if (budget >= 10000) {
                    items.push(...BASE_ITEMS.filter(item => item.price >= 10000 && item.price <= budget * 2).slice(0, 4));
                }
                
                // Add a few aspirational items (slightly out of budget)
                items.push(...BASE_ITEMS.filter(item => item.price > budget && item.price <= budget * 3).slice(0, 2));
                
                // Remove duplicates and limit to 10 items
                const uniqueItems = items.filter((item, index, self) => 
                    index === self.findIndex(t => t.key === item.key)
                ).slice(0, 10);
                
                return uniqueItems;
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-sky-900 to-emerald-800 text-slate-50 p-6 font-sans">
                    <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2">
                            <div className="bg-white/5 rounded-2xl p-6 shadow-lg animate-fade-in">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-sm text-slate-200">Player</div>
                                        <input 
                                            className="mt-2 bg-white/5 border border-white/10 rounded px-3 py-2 text-white placeholder:text-slate-300" 
                                            value={username} 
                                            onChange={e=>setUsername(e.target.value)} 
                                            placeholder="Choose a username" 
                                        />
                                    </div>
                                    <div>
                                        <div className="text-slate-300 text-sm">Balance</div>
                                        <div className="text-3xl font-semibold">{formatMoney(Math.round(balance))}</div>
                                        <div className="text-xs text-slate-300">{inventory.length} items • +{formatMoney(Math.round(hourlyIncome))}/hr</div>
                                        <div className="text-xs text-slate-400">Net Worth: {formatMoney(Math.round(calculateNetWorth()))}</div>
                                    </div>
                                </div>

                                <hr className="my-4 border-white/6" />

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="md:col-span-2">
                                        <label className="text-slate-300 text-sm">Magic Vending Machine</label>
                                        <div className="mt-2 flex gap-2">
                                            <input 
                                                value={requestText} 
                                                onChange={e=>setRequestText(e.target.value)} 
                                                placeholder="Ask for anything (e.g. 'rental property', 'bitcoin', 'Ferrari')" 
                                                className="flex-1 bg-white/5 border border-white/10 rounded px-3 py-2 text-white placeholder:text-slate-300" 
                                            />
                                            <button 
                                                onClick={handleUseMachine} 
                                                disabled={!getCooldownInfo().canUse} 
                                                className={`px-4 py-2 rounded-md font-semibold ${getCooldownInfo().canUse ? 'bg-emerald-500 hover:bg-emerald-400' : 'bg-slate-600/40 cursor-not-allowed'}`}
                                            >
                                                {getCooldownInfo().canUse ? 'Use Machine' : getCooldownInfo().text}
                                            </button>
                                        </div>
                                        <div className="mt-3 text-slate-300 text-sm">
                                            <strong>Try asking for:</strong> <em>restaurant, hotel, skyscraper, yacht, oil rig, solar panels, youtube channel, crypto mining, nft, casino, airport</em>
                                            <br />
                                            <span className="text-xs opacity-75">
                                                Cooldown increases with net worth & income. Early game = no wait!
                                            </span>
                                        </div>
                                    </div>

                                    <div className="bg-white/3 rounded p-3">
                                        <div className="text-xs text-slate-200">Market Snapshot</div>
                                        <div className="mt-2 space-y-1">
                                            <div className="flex items-baseline gap-3">
                                                <div>
                                                    <div className="text-slate-300 text-xs">BTC</div>
                                                    <div className="font-semibold text-lg">{formatMoney(Math.round(btcPrice))}</div>
                                                </div>
                                                <div>
                                                    <div className="text-slate-300 text-xs">Events</div>
                                                    <div className="text-sm">{events.length}</div>
                                                </div>
                                            </div>
                                            <div className="text-xs text-slate-400">
                                                Next cooldown: {(() => {
                                                    const nextCooldown = calculateCooldown(balance, inventory, hourlyIncome);
                                                    if (nextCooldown === 0) return 'None';
                                                    if (nextCooldown >= 24*60*60*1000) return '24h';
                                                    if (nextCooldown >= 60*60*1000) return `${nextCooldown/(60*60*1000)}h`;
                                                    return `${nextCooldown/60000}m`;
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6">
                                    <div className="text-sm text-slate-200">Messages</div>
                                    <div className="mt-2 space-y-2 max-h-40 overflow-auto pr-2">
                                        {messages.map((m,i)=> (
                                            <AnimatedMessage key={i} message={m} index={i} />
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-white/5 rounded-2xl p-4 animate-fade-in">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="text-slate-200 font-semibold">Inventory</div>
                                        <div className="text-slate-300 text-sm">Auto-saves in browser</div>
                                    </div>
                                    <div className="space-y-3 max-h-72 overflow-auto">
                                        {inventory.length===0 ? (
                                            <div className="text-sm text-slate-300">No items yet — try the vending machine.</div>
                                        ) : (
                                            inventory.map((it, idx)=> (
                                                <div key={it.id||idx} className="flex items-center justify-between bg-white/2 rounded p-3">
                                                    <div>
                                                        <div className="font-semibold">{it.name}</div>
                                                        <div className="text-xs text-slate-300">
                                                            {it.category} {it.qty ? `• ${it.qty} unit(s)` : ''}
                                                        </div>
                                                        <div className="text-xs text-slate-300">
                                                            {it.hourly? `+${it.hourly} /hr` : ''} {it.boughtAt ? `• bought ${formatMoney(it.boughtAt)}` : ''}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button 
                                                            onClick={()=>sellItem(idx)} 
                                                            className="text-sm px-3 py-1 rounded bg-amber-500/20"
                                                        >
                                                            Sell
                                                        </button>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white/5 rounded-2xl p-4 animate-fade-in">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="text-slate-200 font-semibold">Active Market Events</div>
                                        <div className="text-slate-300 text-sm">{events.length}</div>
                                    </div>
                                    <div className="space-y-3 max-h-72 overflow-auto">
                                        {events.length===0 ? (
                                            <div className="text-sm text-slate-300">No events right now — the market is calm.</div>
                                        ) : (
                                            events.map(ev=> (
                                                <div key={ev.id+Math.random()} className="p-3 rounded bg-white/3">
                                                    <div className="font-semibold">{ev.label}</div>
                                                    <div className="text-sm text-slate-300">Remaining: {ev.remaining} hours</div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    <div className="mt-4 text-xs text-slate-300">
                                        Random events change pricing & income multipliers. They can help or hurt — trade carefully.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-1">
                            <div className="bg-white/5 rounded-2xl p-4 sticky top-6 animate-fade-in">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="text-slate-200 font-semibold">Quick Shop</div>
                                    <div className="text-xs text-slate-300">Smart picks</div>
                                </div>
                                <div className="space-y-2 max-h-64 overflow-auto">
                                    {getPopularItems().map(it=> (
                                        <div key={it.key} className="flex items-center justify-between bg-white/3 p-2 rounded">
                                            <div className="flex-1 min-w-0">
                                                <div className="font-medium text-sm truncate">{it.name}</div>
                                                <div className="text-xs text-slate-300">{formatMoney(it.price)}</div>
                                                {it.hourly > 0 && (
                                                    <div className="text-xs text-emerald-400">+{formatMoney(it.hourly)}/hr</div>
                                                )}
                                            </div>
                                            <button 
                                                onClick={()=>{ setRequestText(it.name); }} 
                                                className="px-2 py-1 rounded bg-sky-600/20 text-xs ml-2 flex-shrink-0"
                                            >
                                                Ask
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                <hr className="my-4 border-white/6" />
                                <div className="text-sm text-slate-200 mb-2">Utilities</div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={()=>setShowLeaderboard(true)} 
                                        className="flex-1 px-3 py-2 rounded bg-yellow-600/20 text-yellow-300 text-sm"
                                    >
                                        🏆 Board
                                    </button>
                                    <button 
                                        onClick={()=>{ 
                                            navigator.clipboard?.writeText(window.location.href); 
                                            setMessages(m=>[{type:'ok', text:'Share link copied!'}, ...m].slice(0,20)); 
                                        }} 
                                        className="px-3 py-2 rounded bg-violet-500/20 text-sm"
                                    >
                                        Share
                                    </button>
                                    <button onClick={resetGame} className="px-3 py-2 rounded bg-red-600/20 text-sm">Reset</button>
                                </div>
                            </div>

                            <div className="mt-4 bg-white/5 rounded-2xl p-4 animate-fade-in">
                                <div className="text-slate-200 font-semibold mb-2">About</div>
                                <div className="text-slate-300 text-sm">
                                    Magic Vending Machine is a client-side sandbox economy. Start with $1,000, use the vending machine, 
                                    build passive income, and survive market events. Early game has no cooldowns - but as you get richer, 
                                    the machine requires longer waits between uses for balance.
                                </div>
                                <div className="text-xs text-slate-400 mt-3">
                                    <strong>Cooldown Tiers:</strong><br />
                                    Under $10k & $50/hr: No wait<br />
                                    $25k+ or $100+/hr: 5 min<br />
                                    $100k+ or $200+/hr: 15 min<br />
                                    $500k+ or $1k+/hr: 30 min<br />
                                    $2M+ or $5k+/hr: 1 hour<br />
                                    $10M+ or $25k+/hr: 4 hours<br />
                                    $50M+ or $100k+/hr: 24 hours
                                </div>
                                <div className="text-xs text-slate-400 mt-2">
                                    BTC price from CoinGecko API.
                                </div>
                            </div>
                        </div>
                    </div>

                    <LeaderboardModal 
                        isOpen={showLeaderboard} 
                        onClose={() => setShowLeaderboard(false)} 
                        leaderboard={leaderboard}
                        currentUser={username}
                    />
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
